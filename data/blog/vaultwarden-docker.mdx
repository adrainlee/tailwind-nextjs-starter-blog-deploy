---
title: 'ä½¿ç”¨ Docker éƒ¨ç½²ç§æœ‰å¯†ç ç®¡ç†æœåŠ¡ Vaultwarden'
date: '2025-01-18'
tags: ['password-manager', 'vaultwarden', 'docker', 'self-hosted', 'security']
draft: false
summary: 'è¯¦ç»†ä»‹ç»å¦‚ä½•ä½¿ç”¨ Docker éƒ¨ç½²ç§æœ‰å¯†ç ç®¡ç†æœåŠ¡ Vaultwardenï¼ŒåŒ…æ‹¬å®‰å…¨é…ç½®ã€æ€§èƒ½ä¼˜åŒ–ã€è‡ªåŠ¨å¤‡ä»½ç­‰å®Œæ•´è§£å†³æ–¹æ¡ˆã€‚æœ¬æ–‡é€‚åˆæƒ³è¦æ­å»ºç§æœ‰å¯†ç ç®¡ç†ç³»ç»Ÿçš„ä¸ªäººæˆ–å°å‹å›¢é˜Ÿã€‚'
---

## é¡¹ç›®æ¦‚è¿°

Vaultwarden æ˜¯ä¸€ä¸ªç”¨ Rust ç¼–å†™çš„å¼€æºå¯†ç ç®¡ç†æœåŠ¡ï¼Œå®ƒæ˜¯ Bitwarden çš„éå®˜æ–¹æœåŠ¡å™¨å®ç°ã€‚ç›¸æ¯”å®˜æ–¹æœåŠ¡å™¨ï¼Œå®ƒå…·æœ‰ä»¥ä¸‹ä¼˜åŠ¿ï¼š

- èµ„æºå ç”¨æ›´å°‘ï¼ˆå†…å­˜å ç”¨çº¦ 10MBï¼‰
- éƒ¨ç½²ç»´æŠ¤æ›´ç®€å•
- å®Œå…¨å…¼å®¹å®˜æ–¹å®¢æˆ·ç«¯
- æ”¯æŒæ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½
- åªéœ€è¦è®°ä½ä¸€ä¸ªä¸»å¯†ç å°±èƒ½ä½¿ç”¨ï¼Œå¦‚æœå¿˜è®°ä¸»å¯†ç è¿˜æ²¡æœ‰å¯¼å‡ºå¤‡ä»½å°†æ˜¯ä¸€åœºç¾éš¾

æœ¬æ–‡å°†è¯¦ç»†ä»‹ç»å¦‚ä½•ä½¿ç”¨ Docker éƒ¨ç½² Vaultwardenï¼Œå¹¶é…ç½®å¿…è¦çš„å®‰å…¨æªæ–½ã€‚

> **ğŸ“ ç¯å¢ƒä¿¡æ¯**
>
> æœ¬æ–‡åŸºäºä»¥ä¸‹ç¯å¢ƒè¿›è¡Œéƒ¨ç½²ï¼š
>
> - æ“ä½œç³»ç»Ÿï¼šUbuntu 22.04 LTS
> - Docker ç‰ˆæœ¬ï¼š24.0.0 æˆ–æ›´é«˜
> - åŸŸåï¼švault.adrainlee.meï¼ˆè¯·æ›¿æ¢ä¸ºä½ çš„å®é™…åŸŸåï¼‰

## å®‰å…¨æ€§è€ƒè™‘

åœ¨å¼€å§‹éƒ¨ç½²ä¹‹å‰ï¼Œè¯·ç¡®ä¿è€ƒè™‘ä»¥ä¸‹å®‰å…¨æªæ–½ï¼š

1. ç³»ç»Ÿå®‰å…¨

- ä½¿ç”¨é˜²ç«å¢™é™åˆ¶ç«¯å£è®¿é—®
- å¯ç”¨ fail2ban é˜²æ­¢æš´åŠ›æ”»å‡»
- å®šæœŸæ›´æ–°ç³»ç»Ÿå’Œè½¯ä»¶åŒ…

2. æ•°æ®å®‰å…¨

- å¯ç”¨å®šæ—¶å¤‡ä»½
- ä½¿ç”¨åŠ å¯†å­˜å‚¨
- å®æ–½è®¿é—®æ§åˆ¶

3. ç½‘ç»œå®‰å…¨

- é…ç½® SSL/TLS è¯ä¹¦
- å¯ç”¨ HTTP/2
- å®æ–½é€Ÿç‡é™åˆ¶

## éƒ¨ç½²æ­¥éª¤

### 1. å®‰è£… Docker å’Œ Docker Compose

```bash
# å®‰è£… Docker
curl -fsSL https://get.docker.com | bash -s docker

# å°†å½“å‰ç”¨æˆ·æ·»åŠ åˆ° docker ç»„
sudo usermod -aG docker $USER

# åº”ç”¨ç»„æƒé™ï¼ˆæ— éœ€é‡å¯ï¼‰
newgrp docker
```

> **âš ï¸ æ³¨æ„**
>
> ä» Docker Compose V2 å¼€å§‹ï¼Œå‘½ä»¤å·²æ›´æ”¹ä¸º `docker compose`ï¼ˆç§»é™¤äº†ä¸­åˆ’çº¿ï¼‰ã€‚æœ¬æ–‡ä½¿ç”¨æ–°çš„å‘½ä»¤æ ¼å¼ã€‚

### 2. é…ç½® Nginx åå‘ä»£ç†

#### 2.1 å®‰è£…å¿…è¦ç»„ä»¶

```bash
# æ›´æ–°è½¯ä»¶åŒ…åˆ—è¡¨
sudo apt update

# å®‰è£… Nginx
sudo apt install -y nginx

#å®‰è£… Certbot
sudo snap install --classic certbot
```

#### 2.2 é…ç½® Nginx

åœ¨å¼€å§‹é…ç½®nginxçš„ä½œç”¨åœ¨äºï¼Œå¦‚æœä½¿ç”¨httpæ¥è¿æ¥vaultwardenä¼šæœ‰è«åå…¶å¦™çš„é”™è¯¯ï¼Œä¹Ÿæ¯«æ— å®‰å…¨å¯è¨€ï¼Œå¯ä»¥å…ˆé…ç½®å¥½httpså†è¿è¡Œvaultwardenå®¹å™¨å¯ä»¥å¹³æ»‘çš„ä½¿ç”¨

åˆ›å»º Nginx é…ç½®æ–‡ä»¶ï¼š

```nginx
# HTTPS æœåŠ¡å™¨
server {
    listen 80;
    server_name vault.adrainlee.me;

    # å®‰å…¨å¤´éƒ¨
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header Referrer-Policy "no-referrer" always;
    add_header Content-Security-Policy "default-src 'self' https: data: 'unsafe-inline' 'unsafe-eval'" always;

    # Vaultwarden API
    location / {
        proxy_pass http://127.0.0.1:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # WebSocket æ”¯æŒ
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";

        # è¶…æ—¶è®¾ç½®
        proxy_read_timeout 1h;
        proxy_send_timeout 1h;
    }

    # WebSocket é€šçŸ¥
    location /notifications/hub {
        proxy_pass http://127.0.0.1:3012;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_read_timeout 1h;
        proxy_send_timeout 1h;
    }

    # WebSocket åå•†
    location /notifications/hub/negotiate {
        proxy_pass http://127.0.0.1:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

#### 2.3 å¯ç”¨é…ç½®å¹¶ç”³è¯·è¯ä¹¦

```bash
# åˆ›å»ºç¬¦å·é“¾æ¥
sudo ln -s /etc/nginx/sites-available/vaultwarden.conf /etc/nginx/sites-enabled/

# æµ‹è¯•é…ç½®
sudo nginx -t

# é‡å¯ Nginx
sudo systemctl restart nginx

#  å®‰è£…certbot
sudo snap install --classic certbot
sudo ln -s /snap/bin/certbot /usr/bin/certbot

# ç”³è¯· SSL è¯ä¹¦
sudo certbot --nginx -d vault.adrainlee.me

```

å¦‚æœæ²¡æœ‰å®‰è£…certbotè¯·å‚è€ƒå®˜ç½‘æ­¥éª¤å®‰è£… https://certbot.eff.org/

### 3. éƒ¨ç½² Vaultwarden

åœ¨æŒ‡å®šç›®å½•åˆ›å»º Docker Compose é…ç½®æ–‡ä»¶ï¼š

```yaml
services:
  vaultwarden:
    image: vaultwarden/server:latest
    container_name: vaultwarden
    restart: unless-stopped
    ports:
      - '127.0.0.1:8080:80'
      - '127.0.0.1:3012:3012'
    volumes:
      - ./data:/data
    environment:
      # åŸºæœ¬é…ç½®
      - DOMAIN=https://vault.adrainlee.me
      - SIGNUPS_ALLOWED=false #ç¦æ­¢æ³¨å†Œ
      - ADMIN_TOKEN=$(openssl rand -base64 48) #

      # å®‰å…¨é…ç½®
      - LOGIN_RATELIMIT_MAX_BURST=10
      - LOGIN_RATELIMIT_SECONDS=60
      - ADMIN_RATELIMIT_MAX_BURST=10
      - ADMIN_RATELIMIT_SECONDS=60
      - ADMIN_SESSION_LIFETIME=20

      # åŠŸèƒ½é™åˆ¶
      - SENDS_ALLOWED=false
      - EMERGENCY_ACCESS_ALLOWED=false
      - WEB_VAULT_ENABLED=true

    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:80/alive']
      interval: 30s
      timeout: 10s
      retries: 3

  watchtower:
    image: containrrr/watchtower
    container_name: watchtower
    restart: unless-stopped
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - WATCHTOWER_CLEANUP=true
      - WATCHTOWER_POLL_INTERVAL=86400
```

### 4. è‡ªåŠ¨å¤‡ä»½é…ç½®

åˆ›å»ºå¤‡ä»½è„šæœ¬ï¼š

```bash
#!/bin/bash

# é…ç½®
BACKUP_DIR="/opt/vaultwarden/backups"
RETENTION_DAYS=30
TIMESTAMP=$(date +%Y%m%d_%H%M%S)
BACKUP_FILE="vaultwarden_backup_${TIMESTAMP}.tar.gz"
LOG_FILE="${BACKUP_DIR}/backup.log"

# åˆ›å»ºå¤‡ä»½ç›®å½•
mkdir -p "${BACKUP_DIR}"

# å¤‡ä»½æ•°æ®
docker exec vaultwarden sqlite3 /data/db.sqlite3 ".backup '/data/db.sqlite3.backup'"
docker cp vaultwarden:/data/. "${BACKUP_DIR}/temp/"
tar czf "${BACKUP_DIR}/${BACKUP_FILE}" -C "${BACKUP_DIR}/temp" .
rm -rf "${BACKUP_DIR}/temp"

# æ¸…ç†æ—§å¤‡ä»½
find "${BACKUP_DIR}" -type f -name "vaultwarden_backup_*.tar.gz" -mtime +${RETENTION_DAYS} -delete
```

### 5. ç»´æŠ¤å’Œç›‘æ§

#### 5.1 å¥åº·æ£€æŸ¥

```bash
# æ£€æŸ¥å®¹å™¨çŠ¶æ€
docker ps -a | grep vaultwarden

# æŸ¥çœ‹æ—¥å¿—
docker logs -f vaultwarden

# æ£€æŸ¥èµ„æºä½¿ç”¨
docker stats vaultwarden
```

#### 5.2 æ›´æ–°ç®¡ç†

Watchtower ä¼šè‡ªåŠ¨æ£€æŸ¥å¹¶æ›´æ–°å®¹å™¨ã€‚ä½ ä¹Ÿå¯ä»¥æ‰‹åŠ¨æ›´æ–°ï¼š

```bash
# æ‹‰å–æœ€æ–°é•œåƒ
docker pull vaultwarden/server:latest

# é‡å¯å®¹å™¨
docker-compose down
docker-compose up -d
```

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜è§£å†³

1. è¿æ¥é—®é¢˜

- æ£€æŸ¥ Nginx é…ç½®
- éªŒè¯ SSL è¯ä¹¦
- ç¡®è®¤é˜²ç«å¢™è§„åˆ™

2. æ€§èƒ½é—®é¢˜

- ç›‘æ§èµ„æºä½¿ç”¨
- ä¼˜åŒ–æ•°æ®åº“
- æ¸…ç†æ—¥å¿—æ–‡ä»¶

3. å¤‡ä»½æ¢å¤

- å®šæœŸæµ‹è¯•å¤‡ä»½
- éªŒè¯å¤‡ä»½å®Œæ•´æ€§
- å»ºç«‹æ¢å¤æµç¨‹

## æ€»ç»“

é€šè¿‡æœ¬æ–‡çš„é…ç½®ï¼Œä½ å·²ç»æ­å»ºäº†ä¸€ä¸ªå®‰å…¨ã€å¯é çš„ç§æœ‰å¯†ç ç®¡ç†æœåŠ¡ã€‚è®°å¾—å®šæœŸæ£€æŸ¥ç³»ç»Ÿæ›´æ–°ã€å¤‡ä»½æ•°æ®ï¼Œå¹¶ä¿æŒè‰¯å¥½çš„å®‰å…¨å®è·µã€‚
